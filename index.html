<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Procrastination Slayer</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚è≥</text></svg>">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-65WRW2EZF6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-65WRW2EZF6');
  </script>
  <style>
    :root {
      --bg-light: linear-gradient(to right, #e0f7fa, #fff3e0);
      --bg-dark: #121212;
      --text-light: #333;
      --text-dark: #eee;
      --work-color: #81c784;
      --free-color: #e57373;
      --stop-color: #90a4ae;
      --reset-color: #ffd54f;
      --card-bg-light: rgba(255, 255, 255, 0.9);
      --card-bg-dark: rgba(30, 30, 30, 0.9);
      --shadow-light: 0 8px 16px rgba(0, 0, 0, 0.1);
      --shadow-dark: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-light);
      text-align: center;
      padding: 1rem;
      color: var(--text-light);
      transition: all 0.3s;
      margin: 0;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    header {
      position: sticky;
      top: 0;
      background: var(--bg-light);
      padding: 1rem;
      z-index: 100;
      border-radius: 0 0 12px 12px;
      box-shadow: var(--shadow-light);
      backdrop-filter: blur(10px);
    }
    
    body.dark header {
      background: var(--bg-dark);
      box-shadow: var(--shadow-dark);
    }
    
    h1 {
      margin-bottom: 1rem;
      font-size: 2.5rem;
    }
    
    .card {
      background: var(--card-bg-light);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-light);
    }
    
    body.dark .card {
      background: var(--card-bg-dark);
      box-shadow: var(--shadow-dark);
    }

    /* Card title with toggle button */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .toggle-metrics {
      background: transparent;
      border: 1px solid currentColor;
      color: inherit;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .toggle-metrics:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    body.dark .toggle-metrics:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* For collapsible content */
    .collapsible-content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.5s ease-in-out;
    }
    
    .collapsible-content.collapsed {
      max-height: 0;
    }
    
    .timers {
      font-size: 2.2rem;
      margin: 1.5rem 0;
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      gap: 2rem;
    }
    
    .timer-block {
      position: relative;
      transition: transform 0.3s;
    }
    
    .timer-block.active {
      transform: scale(1.05);
    }
    
    .timer-block.work-active::after {
      content: '';
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: var(--work-color);
      border-radius: 50%;
      top: 0;
      right: -20px;
      animation: pulse 2s infinite;
    }
    
    .timer-block.free-active::after {
      content: '';
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: var(--free-color);
      border-radius: 50%;
      top: 0;
      right: -20px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(129, 199, 132, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(129, 199, 132, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(129, 199, 132, 0);
      }
    }
    
    .buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.6rem;
    }
    
    /* Adjust button widths to fit on one line */
    @media (min-width: 768px) {
      .buttons button {
        padding: 0.8rem 1.5rem;
        font-size: 1.1rem;
      }
      
      /* Reorder buttons on desktop */
      #modeBtn {
        order: 6;
      }
      #settingsBtn {
        order: 5;
      }
    }
    
    button {
      font-size: 1.2rem;
      padding: 1rem 2rem;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    button:hover {
      transform: scale(1.05);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    @media (max-width: 768px) {
      button {
        padding: 1rem 1rem;
        font-size: 1.1rem;
        flex-grow: 1;
      }
      
      .buttons {
        margin: 0 -0.25rem;
        gap: 0.4rem;
      }
    }
    
    .work {
      background-color: var(--work-color);
      color: #fff;
    }
    
    .free {
      background-color: var(--free-color);
      color: #fff;
    }
    
    .stop {
      background-color: var(--stop-color);
      color: #fff;
    }
    
    .reset {
      background-color: var(--reset-color);
      color: #333;
    }
    
    .status {
      font-size: 1.2rem;
      margin-top: 1rem;
      font-style: italic;
    }
    
    .toggle-mode {
      background: transparent;
      color: inherit;
      border: 2px solid currentColor;
    }
    
    .charts-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      margin: 2rem 0;
    }
    
    .chart-wrapper {
      flex: 1;
      min-width: 300px;
    }
    
    canvas {
      max-width: 100%;
      margin: 0 auto;
    }
    
    .stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .stat-item {
      padding: 1rem;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.2);
      min-width: 200px;
    }
    
    body.dark .stat-item {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .quote {
      margin-top: 2rem;
      font-style: italic;
      font-size: 1.1rem;
      opacity: 0.9;
      padding: 1rem;
    }
    
    .settings-button {
      background-color: transparent;
      border: 1px solid currentColor;
      color: inherit;
      margin-left: auto;
    }
    
    .settings-panel {
      height: 0;
      overflow: hidden;
      transition: height 0.3s;
    }
    
    .settings-panel.open {
      height: auto;
      padding: 1.5rem 1rem;
    }
    
    .settings-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      align-items: start;
    }
    
    .settings-form label,
    .settings-group-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.8rem;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    body.dark .settings-form label,
    body.dark .settings-group-container,
    body.dark .pomodoro-container {
      background-color: rgba(80, 80, 80, 0.15);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .settings-form label:hover,
    .pomodoro-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .settings-form input[type="checkbox"] {
      margin-right: 0.5rem;
      cursor: pointer;
      width: 16px;
      height: 16px;
    }
    
    .settings-form input[type="number"] {
      width: 80px;
      padding: 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: rgba(255, 255, 255, 0.9);
      transition: all 0.2s ease;
    }
    
    body.dark .settings-form input[type="number"] {
      background-color: rgba(60, 60, 60, 0.8);
      color: #eee;
      border-color: #555;
    }
    
    .settings-form input[type="number"]:focus {
      outline: none;
      border-color: #81c784;
      box-shadow: 0 0 0 2px rgba(129, 199, 132, 0.3);
    }
    
    .settings-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .pomodoro-container {
      grid-column: span 2;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem;
      background-color: rgba(255, 150, 0, 0.08);
      border-radius: 8px;
      border: 1px dashed rgba(255, 150, 0, 0.3);
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    body.dark .pomodoro-container {
      background-color: rgba(255, 150, 0, 0.1);
      border-color: rgba(255, 150, 0, 0.2);
    }
    
    .pomodoro-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
      font-weight: 500;
      color: #ff9800;
    }
    
    body.dark .pomodoro-title {
      color: #ffb74d;
    }
    
    .pomodoro-settings {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      padding-left: 1.8rem;
      margin-top: 0.5rem;
    }
    
    .pomodoro-item {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      background-color: rgba(255, 255, 255, 0.15);
      padding: 0.6rem 0.8rem;
      border-radius: 5px;
      min-width: 120px;
    }
    
    body.dark .pomodoro-item {
      background-color: rgba(80, 80, 80, 0.3);
    }
    
    .setting-label {
      font-weight: 500;
      margin-bottom: 0.2rem;
    }
    
    .info-icon {
      cursor: help;
      display: inline-block;
      width: 18px;
      height: 18px;
      background-color: rgba(255, 150, 0, 0.8);
      color: white;
      border-radius: 50%;
      font-size: 12px;
      line-height: 18px;
      text-align: center;
      position: relative;
      margin-left: 5px;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 250px;
      background-color: rgba(90, 90, 110, 0.85);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      top: -5px;
      left: 125%;
      opacity: 0;
      transition: opacity 0.3s;
      font-weight: normal;
      font-size: 0.85rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 50%;
      right: 100%;
      margin-top: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: transparent rgba(0, 0, 0, 0.8) transparent transparent;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .setting-help {
      font-size: 0.8em;
      opacity: 0.7;
      margin-left: 0.3rem;
      font-style: italic;
    }
    
    .target-line {
      position: absolute;
      width: 100%;
      border-top: 2px dashed #ff9800;
      z-index: 10;
    }
    
    /* Language switch styles */
    .lang-switch {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 0.9rem;
      opacity: 0.7;
      transition: opacity 0.3s;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      color: inherit;
    }
    
    .lang-switch:hover {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    @media (max-width: 600px) {
      .lang-switch {
        top: 0.5rem;
        right: 0.5rem;
      }
    }

    /* NEW MOBILE OPTIMIZATIONS */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }
      
      header {
        padding: 0.7rem 0.5rem;
      }
      
      .timers {
        font-size: 1.5rem;
        margin: 0.8rem 0;
        gap: 1rem;
      }
      
      .timer-block.work-active::after,
      .timer-block.free-active::after {
        width: 10px;
        height: 10px;
        right: -15px;
      }
      
      .card {
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      
      .stats {
        gap: 0.5rem;
      }
      
      .stat-item {
        padding: 0.8rem;
        min-width: auto;
        flex: 1 0 45%;
      }
      
      .pomodoro-settings {
        padding-left: 0;
      }
      
      .pomodoro-item {
        min-width: 100px;
      }
    }
    
    /* Extra optimizations for very small screens */
    @media (max-width: 480px) {
      body {
        padding: 0.5rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .container {
        padding: 0;
      }
      
      .timers {
        font-size: 1.2rem;
        flex-direction: row;
        align-items: center;
        gap: 0.8rem;
      }
      
      .buttons button {
        padding: 0.7rem 0.8rem;
        font-size: 0.95rem;
      }
      
      .status {
        font-size: 1rem;
      }
      
      .chart-wrapper {
        min-width: 100%;
      }
      
      .settings-form {
        grid-template-columns: 1fr;
      }
      
      .pomodoro-container {
        grid-column: span 1;
      }
      
      .tooltip .tooltip-text {
        width: 200px;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
      }
      
      .tooltip .tooltip-text::after {
        top: -10px;
        left: 50%;
        margin-left: -5px;
        border-color: transparent transparent rgba(0, 0, 0, 0.8) transparent;
        right: auto;
      }
    }
  </style>
</head>
<body>
  <button class="lang-switch" onclick="toggleLanguage()">üåê CZ/EN</button>
  
  <div class="container">
    <header>
      <h1 id="title">‚è≥ Procrastination Slayer</h1>
      <div class="timers">
        <div id="workTimer" class="timer-block">
          üü¢ <span id="workTime">0:00:00</span>
        </div>
        <div id="freeTimer" class="timer-block">
          üî¥ <span id="freeTime">0:00:00</span>
        </div>
      </div>
    </header>
    
    <div class="card">
      <div class="buttons">
        <button id="workBtn" class="work" onclick="startTracking('work')">Working</button>
        <button id="freeBtn" class="free" onclick="startTracking('free')">Free Time</button>
        <button id="stopBtn" class="stop" onclick="stopTracking()">‚èπÔ∏è Stop</button>
        <button id="resetBtn" class="reset" onclick="resetTimers()">üîÑ Reset</button>
        <button id="modeBtn" class="toggle-mode" onclick="toggleDarkMode()">üåì Mode</button>
        <button id="settingsBtn" class="settings-button" onclick="toggleSettings()">‚öôÔ∏è</button>
      </div>
      <div class="status" id="status">No timer running.</div>
      
      <div id="settingsPanel" class="settings-panel">
        <div class="settings-form">
          <label>
            <span class="setting-label" id="soundLabel">Sound Notifications</span>
            <div class="settings-group">
              <input type="checkbox" id="enableSounds" checked>
            </div>
          </label>
          <label>
            <span class="setting-label" id="targetLabel">Daily Work Target (hours)</span>
            <input type="number" id="workTarget" min="1" step="1" value="4">
          </label>
          <label>
            <span class="setting-label" id="hideMetricsLabel">Hide Metrics Completely</span>
            <div class="settings-group">
              <input type="checkbox" id="hideMetricsCompletely">
              <span class="setting-help" id="hideMetricsHelp">Removes the metrics section entirely from view</span>
            </div>
          </label>
          <div class="pomodoro-container">
            <div class="pomodoro-title">
              <input type="checkbox" id="enablePomodoro">
              <span id="pomodoroLabel">Pomodoro Mode</span>
              <div class="tooltip">
                <div class="info-icon">i</div>
                <span class="tooltip-text" id="pomodoroHelp">A technique where you work in focused time blocks (e.g. 25 min) followed by short breaks to maximize productivity.</span>
              </div>
            </div>
            <div class="pomodoro-settings">
              <div class="pomodoro-item">
                <span id="workMinLabel">Work minutes</span>
                <input type="number" id="pomodoroWork" min="1" max="60" value="25">
              </div>
              <div class="pomodoro-item">
                <span id="breakMinLabel">Break minutes</span>
                <input type="number" id="pomodoroBreak" min="1" max="30" value="5">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card" id="metricsCard">
      <div class="card-header">
        <h2 id="progressTitle">Today's Progress</h2>
        <button id="toggleMetricsBtn" class="toggle-metrics" onclick="toggleMetrics()">
          <span id="toggleMetricsText">Hide Metrics</span> <span id="toggleIcon">‚ñº</span>
        </button>
      </div>
      
      <div id="metricsContent" class="collapsible-content">
        <div class="stats">
          <div class="stat-item">
            <h3 id="ratioTitle">Work Ratio</h3>
            <div id="workRatio">0%</div>
          </div>
          <div class="stat-item">
            <h3 id="targetTitle">Daily Target</h3>
            <div id="targetProgress">0/4 hours</div>
          </div>
          <div class="stat-item">
            <h3 id="efficiencyTitle">Efficiency</h3>
            <div id="efficiency">0%</div>
          </div>
        </div>
        
        <div class="charts-container">
          <div class="chart-wrapper">
            <canvas id="timeChart"></canvas>
          </div>
          <div class="chart-wrapper">
            <canvas id="historyChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="quote" id="quote">"The best way to get something done is to begin."</div>
    </div>
  </div>

  <audio id="beep">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>
  
  <audio id="achievement">
    <source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg">
  </audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <script>
    // Version number to detect data structure changes
    const APP_VERSION = '1.2.0';
    
    // Global timer variables
    let workSeconds = 0;
    let freeSeconds = 0;
    let interval;
    let current = null;
    let currentStartTime = null; // Timestamp when the current session started
    let dailyData = {};
    let pomodoroInterval = null;
    let pomodoroSecondsLeft = 0;
    let language = 'en'; // Default language
    let metricsVisible = true; // Default visibility state for metrics
    let metricsEnabled = true; // Whether to show the metrics card at all
    let saveInterval = null; // For periodic saving
    
    const TODAY = new Date().toISOString().split('T')[0];
    
    // Store version in localStorage to detect version changes
    if (localStorage.getItem('appVersion') !== APP_VERSION) {
      localStorage.setItem('appVersion', APP_VERSION);
      // Could perform any data migration here if needed
    }

    const beep = document.getElementById('beep');
    const achievement = document.getElementById('achievement');
    const quoteEl = document.getElementById('quote');
    const workTimerEl = document.getElementById('workTimer');
    const freeTimerEl = document.getElementById('freeTimer');
    
    // Tim Urban / Wait But Why inspired quotes
    const quotes = {
      en: [
        "There are only two things left between you and achievement: discipline and 'future you' not being a jerk.",
        "If you're spending 80% of your time in the Dark Playground, we have a problem.",
        "Future You will enjoy the rewards of your work today, but only if Present You stops scrolling.",
        "The Panic Monster isn't your friend, but maybe he's the accountability partner you deserve.",
        "Your life is just a series of Present Moments‚Ñ¢. How will you spend this one?",
        "Successful people aren't superhumans. They're just better at making friends with discomfort.",
        "Between Instant Gratification Monkey and Rational Decision-Maker, who's driving your brain today?",
        "The distance between 'I should' and 'I did' is your entire life story.",
        "The most effective productivity hack: making your Future Self not hate your Past Self.",
        "The hardest thing about hard work isn't the work‚Äîit's convincing yourself to do it when the monkey's in charge.",
        "If you wait until you feel like doing something, you'll spend most of your life waiting.",
        "The Instant Gratification Monkey believes all deadlines are fake until the night before.",
        "Every minute spent wallowing in the Dark Playground is a minute you'll never get back.",
        "You've been blessed with consciousness in a universe of matter. Maybe don't waste it watching cat videos?",
        "Being productive isn't about doing more things‚Äîit's about doing more of the right things."
      ],
      cz: [
        "Mezi tebou a √∫spƒõchem stoj√≠ jen dvƒõ vƒõci: discipl√≠na a to, ≈æe 'budouc√≠ ty' nebude blbec.",
        "Odkl√°d√°n√≠ snadn√© vƒõci ztƒõ≈æuje a tƒõ≈æk√© vƒõci znemo≈æ≈àuje.",
        "Budouc√≠ Ty si u≈æije odmƒõny za tvou dne≈°n√≠ pr√°ci, ale jen pokud Souƒçasn√Ω Ty p≈ôestane scrollovat.",
        "Ot√°len√≠ je zlozvyk odkl√°dat na poz√≠t≈ô√≠ to, co mƒõlo b√Ωt provedeno p≈ôedevƒç√≠rem.",
        "Tv≈Øj ≈æivot je jen s√©rie P≈ô√≠tomn√Ωch okam≈æik≈Ø‚Ñ¢. Jak vyu≈æije≈° tenhle?",
        "√öspƒõ≈°n√≠ lid√© nejsou supermani. Jen se l√©pe kamar√°d√≠ s nepohodl√≠m.",
        "Nic nen√≠ tak unavuj√≠c√≠ jako vƒõƒçnƒõ nedokonƒçen√Ω √∫kol.",
        "Vzd√°lenost mezi 'mƒõl bych' a 'udƒõlal jsem' je cel√Ω p≈ô√≠bƒõh tv√©ho ≈æivota.",
        "Nejefektivnƒõj≈°√≠ produktivn√≠ trik: za≈ô√≠dit, aby tv√© Budouc√≠ j√° nechtƒõlo nen√°vidƒõt tv√© Minul√© j√°.",
        "Doba na≈°eho ≈æivota je omezen√° a koneƒçn√°. Vzhledem k t√©to skuteƒçnosti je pr√°vƒõ ƒças t√≠m nejhodnotnƒõj≈°√≠m, co v ≈æivotƒõ m√°me.",
        "Pokud ƒçek√°≈°, a≈æ bude≈° m√≠t chu≈• nƒõco udƒõlat, str√°v√≠≈° vƒõt≈°inu ≈æivota ƒçek√°n√≠m.",
        "Miluji term√≠ny. Miluji zvuk, kter√Ω vyd√°vaj√≠, kdy≈æ prolet√≠ kolem.",
        "Byl jsi po≈æehn√°n vƒõdom√≠m ve vesm√≠ru hmoty. Mo≈æn√° to nepl√Ωtvej sledov√°n√≠m vide√≠ s koƒçkami?",
        "B√Ωt produktivn√≠ nen√≠ o dƒõl√°n√≠ v√≠ce vƒõc√≠‚Äîje to o dƒõl√°n√≠ v√≠ce spr√°vn√Ωch vƒõc√≠.",
        "Pokud vƒõ≈ô√≠≈° s√°m sobƒõ... a vƒõ≈ô√≠≈° ve sv√© sny... a sleduje≈° svou hvƒõzdu... p≈ôesto tƒõ poraz√≠ lid√©, kte≈ô√≠ str√°vili ƒças tvrdou prac√≠ a uƒçen√≠m a nebyli tak l√≠n√≠."  
      ]
    };
    
    // UI text translations
    const uiText = {
      en: {
        title: "‚è≥ Procrastination Slayer",
        workBtn: "Working",
        freeBtn: "Free Time",
        stopBtn: "‚èπÔ∏è Stop",
        resetBtn: "üîÑ Reset",
        modeBtn: "üåì Mode",
        settingsBtn: "‚öôÔ∏è",
        status: "No timer running.",
        soundLabel: "Sound Notifications",
        targetLabel: "Daily Work Target (hours)",
        hideMetricsLabel: "Hide Metrics Completely",
        hideMetricsHelp: "Removes the metrics section entirely from view",
        pomodoroLabel: "Pomodoro Mode",
        pomodoroTooltip: "A technique where you work in focused time blocks (e.g. 25 min) followed by short breaks to maximize productivity.",
        workMinLabel: "Work minutes",
        breakMinLabel: "Break minutes",
        progressTitle: "Today's Progress",
        ratioTitle: "Work Ratio",
        targetTitle: "Daily Target",
        efficiencyTitle: "Efficiency",
        trackingWork: "Tracking Work...",
        trackingFree: "Tracking Free Time...",
        paused: "Paused",
        noTimer: "No timer running.",
        timersReset: "Timers reset.",
        pomodoroComplete: "Pomodoro session complete! Take a",
        minuteBreak: "minute break?",
        distributionTitle: "Today's Distribution",
        historyTitle: "Last 7 Days",
        hours: "Hours",
        confirmReset: "Are you sure you want to reset today's timers?",
        pomodoroStatus: "Tracking Work... Pomodoro:",
        remaining: "remaining",
        pomodoroNotification: "Pomodoro Complete",
        breakTime: "Time for a break!",
        milestoneNotification: "Productivity Milestone",
        congratsMessage: "Congratulations! You've worked for",
        hoursToday: "hours today.",
        hideMetrics: "Hide Metrics",
        showMetrics: "Show Metrics"
      },
      cz: {
        title: "‚è≥ Hl√≠daƒç prokrastinace",
        workBtn: "Zaƒç√≠t pr√°ci",
        freeBtn: "Zaƒç√≠t pauzu",
        stopBtn: "‚èπÔ∏è Stop",
        resetBtn: "üîÑ Reset",
        modeBtn: "üåì Re≈æim",
        settingsBtn: "‚öôÔ∏è",
        status: "≈Ω√°dn√Ω ƒçasovaƒç nebƒõ≈æ√≠.",
        soundLabel: "Zvukov√° upozornƒõn√≠",
        targetLabel: "Denn√≠ c√≠l pr√°ce (hodiny)",
        hideMetricsLabel: "Zcela skr√Ωt metriky",
        hideMetricsHelp: "Kompletnƒõ odstran√≠ sekci metrik z pohledu",
        pomodoroLabel: "Pomodoro re≈æim",
        pomodoroTooltip: "Technika, p≈ôi kter√© pracujete v soust≈ôedƒõn√Ωch ƒçasov√Ωch bloc√≠ch (nap≈ô. 25 min) n√°sledovan√Ωch kr√°tk√Ωmi p≈ôest√°vkami pro zv√Ω≈°en√≠ produktivity.",
        workMinLabel: "Minuty pr√°ce",
        breakMinLabel: "Minuty p≈ôest√°vky",
        progressTitle: "Dne≈°n√≠ pokrok",
        ratioTitle: "Pomƒõr pr√°ce",
        targetTitle: "Denn√≠ c√≠l",
        efficiencyTitle: "Efektivita",
        trackingWork: "Sledov√°n√≠ pr√°ce...",
        trackingFree: "Sledov√°n√≠ voln√©ho ƒçasu...",
        paused: "Pozastaveno",
        noTimer: "≈Ω√°dn√Ω ƒçasovaƒç nebƒõ≈æ√≠.",
        timersReset: "ƒåasovaƒçe resetov√°ny.",
        pomodoroComplete: "Pomodoro dokonƒçeno! D√°t si",
        minuteBreak: "minutovou p≈ôest√°vku?",
        distributionTitle: "Dne≈°n√≠ rozlo≈æen√≠",
        historyTitle: "Posledn√≠ch 7 dn√≠",
        hours: "hodin",
        confirmReset: "Opravdu chcete resetovat dne≈°n√≠ ƒçasovaƒçe?",
        pomodoroStatus: "Sledov√°n√≠ pr√°ce... Pomodoro:",
        remaining: "zb√Ωv√°",
        pomodoroNotification: "Pomodoro dokonƒçeno",
        breakTime: "ƒåas na p≈ôest√°vku!",
        milestoneNotification: "Produktivn√≠ miln√≠k",
        congratsMessage: "Gratulujeme! Dnes jste pracovali",
        hoursToday: "hodin.",
        hideMetrics: "Skr√Ωt metriky",
        showMetrics: "Zobrazit metriky"
      }
    };

    // Handle application load or reloads (F5)
    window.addEventListener('load', function() {
      // Auto-detect browser language
      const browserLang = navigator.language || navigator.userLanguage;
      
      // Set default language based on browser settings
      if (localStorage.getItem('language')) {
        language = localStorage.getItem('language');
      } else {
        if (browserLang.startsWith('cs') || browserLang.startsWith('cz')) {
          language = 'cz';
        } else {
          language = 'en';
        }
        localStorage.setItem('language', language);
      }
      
      // Load metrics visibility preference
      if (localStorage.getItem('metricsVisible') !== null) {
        metricsVisible = localStorage.getItem('metricsVisible') === 'true';
        updateMetricsVisibility();
      }
      
      // Load metrics enabled preference
      if (localStorage.getItem('metricsEnabled') !== null) {
        metricsEnabled = localStorage.getItem('metricsEnabled') === 'true';
        const hideMetricsCheckbox = document.getElementById('hideMetricsCompletely');
        if (hideMetricsCheckbox) {
          hideMetricsCheckbox.checked = !metricsEnabled;
        }
        updateMetricsEnabled();
      }
      
      // Load timers and data
      loadData();
      checkForNewDay();
      
      // Update the interface
      updateDisplay();
      updateStats();
      updateUILanguage();
      
      try {
        // Explicitly initialize and draw charts
        initializeCharts();
        drawCharts();
      } catch (err) {
        console.error('Error initializing charts:', err);
      }
      
      showRandomQuote();
      
      if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission();
      }
      
      // Start periodic saving every 10 seconds
      if (!saveInterval) {
        saveInterval = setInterval(function() {
          saveData();
        }, 10000);
      }
    });
    
    // Check if this is a new day compared to the last visit
    function checkForNewDay() {
      const lastVisitDate = localStorage.getItem('lastVisitDate');
      
      if (lastVisitDate && lastVisitDate !== TODAY) {
        console.log('New day detected:', lastVisitDate, '->', TODAY);
        
        // It's a new day, ensure today's entry exists but with zeros
        // This ensures we don't carry over yesterday's times
        if (!dailyData[TODAY]) {
          console.log('Creating entry for new day with zeros');
          dailyData[TODAY] = { work: 0, free: 0 };
          
          // Since it's a new day, also reset the session counters
          // but keep the previous day's data in history
          workSeconds = 0;
          freeSeconds = 0;
          
          // Make sure we save these changes
          saveData();
        }
      }
      
      // Update the last visit date
      localStorage.setItem('lastVisitDate', TODAY);
    }
    
    // Handle beforeunload event to save data before page refresh/close
    window.addEventListener('beforeunload', function() {
      // If a timer is running, save the current elapsed time
      if (current) {
        const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
        if (current === 'work') {
          workSeconds += elapsed;
          dailyData[TODAY].work = workSeconds;
        } else if (current === 'free') {
          freeSeconds += elapsed;
          dailyData[TODAY].free = freeSeconds;
        }
      }
      
      // Save data immediately
      saveData();
    });
    
    // Handle page visibility changes (tab switching, etc.)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && current) {
        // Save data when switching away from the page
        const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
        if (current === 'work') {
          // Temporarily save without disrupting the timer
          const tempWork = workSeconds + elapsed;
          dailyData[TODAY].work = tempWork;
        } else if (current === 'free') {
          const tempFree = freeSeconds + elapsed;
          dailyData[TODAY].free = tempFree;
        }
        saveData();
      } else if (!document.hidden) {
        // When returning to the page, update displays
        updateDisplay();
        updateStats();
      }
    });
    
    function loadData() {
      try {
        // Clear console for better debugging
        console.clear();
        console.log('Loading data for date:', TODAY);
        
        // Load daily data with error handling
        if (localStorage.getItem('dailyData')) {
          try {
            const storedData = localStorage.getItem('dailyData');
            if (storedData) {
              dailyData = JSON.parse(storedData) || {};
              console.log('Loaded daily data:', dailyData);
            }
          } catch (e) {
            console.error('Error parsing dailyData:', e);
            dailyData = {};
          }
        }
        
        // Ensure today's data exists
        if (!dailyData[TODAY]) {
          console.log('Creating new entry for today');
          dailyData[TODAY] = {
            work: 0,
            free: 0
          };
        }
        
        // Load work and free seconds from today's data
        workSeconds = dailyData[TODAY].work || 0;
        freeSeconds = dailyData[TODAY].free || 0;
        
        console.log('Loaded timers:', {
          work: formatTime(workSeconds),
          free: formatTime(freeSeconds)
        });
        
        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
          document.body.classList.add('dark');
        }
        
        // Save immediately to ensure consistency
        saveData();
        
      } catch (err) {
        console.error('Error loading data:', err);
        // Fallback to defaults if there's an error
        workSeconds = 0;
        freeSeconds = 0;
        dailyData = { [TODAY]: { work: 0, free: 0 } };
      }
    }
    
    function toggleLanguage() {
      language = language === 'en' ? 'cz' : 'en';
      localStorage.setItem('language', language);
      updateUILanguage();
      showRandomQuote();
      
      if (timeChart && historyChart) {
        timeChart.data.labels = language === 'en' ? ['Work', 'Free Time'] : ['Pr√°ce', 'Voln√Ω ƒåas'];
        timeChart.update();
        
        const text = uiText[language];
        historyChart.options.plugins.title.text = text.historyTitle;
        historyChart.options.scales.y.title.text = text.hours;
        historyChart.data.datasets[0].label = language === 'en' ? 'Work Hours' : 'Pracovn√≠ Hodiny';
        historyChart.data.datasets[1].label = language === 'en' ? 'Free Hours' : 'Voln√© Hodiny';
        
        const dates = Object.keys(dailyData).sort().slice(-7);
        const displayDates = dates.map(date => {
          const d = new Date(date);
          return d.toLocaleDateString(language === 'en' ? 'en-US' : 'cs-CZ', { weekday: 'short' });
        });
        historyChart.data.labels = displayDates;
        
        historyChart.update();
      }
    }
    
    function updateUILanguage() {
      const text = uiText[language];
      document.getElementById('title').textContent = text.title;
      document.getElementById('workBtn').textContent = text.workBtn;
      document.getElementById('freeBtn').textContent = text.freeBtn;
      document.getElementById('stopBtn').textContent = text.stopBtn;
      document.getElementById('resetBtn').textContent = text.resetBtn;
      document.getElementById('modeBtn').textContent = text.modeBtn;
      document.getElementById('settingsBtn').textContent = text.settingsBtn;
      document.getElementById('status').textContent = current ? 
        `${text.paused} (${current === 'work' ? text.workBtn : text.freeBtn})` : 
        text.noTimer;
      
      document.getElementById('soundLabel').textContent = text.soundLabel;
      document.getElementById('targetLabel').textContent = text.targetLabel;
      document.getElementById('hideMetricsLabel').textContent = text.hideMetricsLabel;
      document.getElementById('hideMetricsHelp').textContent = text.hideMetricsHelp;
      document.getElementById('pomodoroLabel').textContent = text.pomodoroLabel;
      document.getElementById('pomodoroHelp').textContent = text.pomodoroTooltip;
      document.getElementById('workMinLabel').textContent = text.workMinLabel;
      document.getElementById('breakMinLabel').textContent = text.breakMinLabel;
      
      document.getElementById('progressTitle').textContent = text.progressTitle;
      document.getElementById('ratioTitle').textContent = text.ratioTitle;
      document.getElementById('targetTitle').textContent = text.targetTitle;
      document.getElementById('efficiencyTitle').textContent = text.efficiencyTitle;
      
      // Update the toggle metrics button text
      document.getElementById('toggleMetricsText').textContent = 
        metricsVisible ? text.hideMetrics : text.showMetrics;
      
      updateStats();
    }

    // Toggle metrics visibility (collapse/expand)
    function toggleMetrics() {
      metricsVisible = !metricsVisible;
      localStorage.setItem('metricsVisible', metricsVisible);
      updateMetricsVisibility();
    }
    
    function updateMetricsVisibility() {
      const metricsContent = document.getElementById('metricsContent');
      const toggleIcon = document.getElementById('toggleIcon');
      const toggleText = document.getElementById('toggleMetricsText');
      const text = uiText[language];
      
      if (metricsVisible) {
        metricsContent.classList.remove('collapsed');
        toggleIcon.textContent = '‚ñº';
        toggleText.textContent = text.hideMetrics;
      } else {
        metricsContent.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleText.textContent = text.showMetrics;
      }
    }
    
    // Toggle whether metrics section should be shown at all
    function toggleMetricsEnabled() {
      metricsEnabled = !document.getElementById('hideMetricsCompletely').checked;
      localStorage.setItem('metricsEnabled', metricsEnabled);
      updateMetricsEnabled();
    }
    
    function updateMetricsEnabled() {
      const metricsCard = document.getElementById('metricsCard');
      
      if (metricsEnabled) {
        metricsCard.style.display = '';
      } else {
        metricsCard.style.display = 'none';
      }
    }

    // Start tracking using timestamp-based calculations for accuracy
    function startTracking(mode) {
      stopTracking();
      current = mode;
      currentStartTime = Date.now();
      
      if (document.getElementById('enableSounds').checked) {
        beep.play();
      }
      
      const text = uiText[language];
      document.getElementById('status').textContent = mode === 'work' ? text.trackingWork : text.trackingFree;
      
      if (mode === 'work') {
        workTimerEl.classList.add('active', 'work-active');
        freeTimerEl.classList.remove('active', 'free-active');
      } else {
        freeTimerEl.classList.add('active', 'free-active');
        workTimerEl.classList.remove('active', 'work-active');
      }
      
      if (document.getElementById('enablePomodoro').checked && mode === 'work') {
        startPomodoro();
      }
      
      interval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
        if (mode === 'work') {
          dailyData[TODAY].work = workSeconds + elapsed;
          if ((workSeconds + elapsed) % 3600 === 0 && (workSeconds + elapsed) > 0) {
            celebrateHourMilestone();
          }
        } else {
          dailyData[TODAY].free = freeSeconds + elapsed;
        }
        updateDisplay();
        updateStats();
        saveData();
      }, 1000);
    }
    
    function startPomodoro() {
      const workMinutes = parseInt(document.getElementById('pomodoroWork').value);
      pomodoroSecondsLeft = workMinutes * 60;
      
      updatePomodoroStatus();
      
      pomodoroInterval = setInterval(() => {
        pomodoroSecondsLeft--;
        updatePomodoroStatus();
        
        if (pomodoroSecondsLeft <= 0) {
          clearInterval(pomodoroInterval);
          notifyPomodoroComplete();
        }
      }, 1000);
    }
    
    function updatePomodoroStatus() {
      const text = uiText[language];
      const minutes = Math.floor(pomodoroSecondsLeft / 60);
      const seconds = pomodoroSecondsLeft % 60;
      document.getElementById('status').textContent = 
        `${text.pomodoroStatus} ${minutes}:${String(seconds).padStart(2, '0')} ${text.remaining}`;
    }
    
    function notifyPomodoroComplete() {
      const text = uiText[language];
      
      if (document.getElementById('enableSounds').checked) {
        achievement.play();
      }
      
      if (Notification.permission === 'granted') {
        new Notification(text.pomodoroNotification, {
          body: text.breakTime,
          icon: 'https://cdn-icons-png.flaticon.com/512/3981/3981760.png'
        });
      }
      
      const breakMinutes = parseInt(document.getElementById('pomodoroBreak').value);
      
      if (confirm(`${text.pomodoroComplete} ${breakMinutes} ${text.minuteBreak}`)) {
        stopTracking();
        startTracking('free');
        
        setTimeout(() => {
          if (current === 'free') {
            stopTracking();
            startTracking('work');
          }
        }, breakMinutes * 60 * 1000);
      }
    }
    
    function celebrateHourMilestone() {
      const text = uiText[language];
      const hoursWorked = Math.floor(dailyData[TODAY].work / 3600);
      
      if (document.getElementById('enableSounds').checked) {
        achievement.play();
      }
      
      if (Notification.permission === 'granted') {
        new Notification(text.milestoneNotification, {
          body: `${text.congratsMessage} ${hoursWorked} ${text.hoursToday}`,
          icon: 'https://cdn-icons-png.flaticon.com/512/3981/3981760.png'
        });
      }
    }
    
    // When stopping, add elapsed time to the base and clear the timer
    function stopTracking() {
      if (current) {
        const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
        if (current === 'work') {
          workSeconds += elapsed;
          dailyData[TODAY].work = workSeconds;
        } else if (current === 'free') {
          freeSeconds += elapsed;
          dailyData[TODAY].free = freeSeconds;
        }
        
        // Save after stopping to ensure data is preserved
        saveData();
      }
      clearInterval(interval);
      clearInterval(pomodoroInterval);
      workTimerEl.classList.remove('active', 'work-active');
      freeTimerEl.classList.remove('active', 'free-active');
      
      const text = uiText[language];
      if (current) {
        document.getElementById('status').textContent = `${text.paused} (${current === 'work' ? text.workBtn : text.freeBtn})`;
      } else {
        document.getElementById('status').textContent = text.noTimer;
      }
      current = null;
      currentStartTime = null;
    }

    function resetTimers() {
      const text = uiText[language];
      const confirmReset = confirm(text.confirmReset);
      if (confirmReset) {
        stopTracking();
        workSeconds = 0;
        freeSeconds = 0;
        dailyData[TODAY] = { work: 0, free: 0 };
        saveData();
        updateDisplay();
        updateStats();
        drawCharts();
        document.getElementById('status').textContent = text.timersReset;
        showRandomQuote();
      }
    }
    
    // Create a new day entry
    function resetDayData() {
      // Reset day data but remember the timer counts
      const oldData = { ...dailyData[TODAY] }; // Save previous values
      
      dailyData[TODAY] = {
        work: 0,
        free: 0
      };
      
      workSeconds = 0;
      freeSeconds = 0;
      
      saveData();
      console.log('Day data reset from:', oldData, 'to:', dailyData[TODAY]);
    }
    
    function saveData() {
      try {
        localStorage.setItem('workSeconds', workSeconds);
        localStorage.setItem('freeSeconds', freeSeconds);
        localStorage.setItem('dailyData', JSON.stringify(dailyData));
      } catch (err) {
        console.error('Error saving data:', err);
        
        // Try to clear some space if localStorage is full
        if (err.name === 'QuotaExceededError') {
          // Clean up old data (anything older than 30 days)
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          const cutoffDate = thirtyDaysAgo.toISOString().split('T')[0];
          
          let cleaned = false;
          Object.keys(dailyData).forEach(date => {
            if (date < cutoffDate) {
              delete dailyData[date];
              cleaned = true;
            }
          });
          
          if (cleaned) {
            // Try again after cleaning
            try {
              localStorage.setItem('dailyData', JSON.stringify(dailyData));
            } catch (e) {
              console.error('Still cannot save data after cleanup:', e);
            }
          }
        }
      }
    }

    // Update display considering the current running session
    function updateDisplay() {
      let displayedWork = workSeconds;
      let displayedFree = freeSeconds;
      if (current) {
        const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
        if (current === 'work') {
          displayedWork = workSeconds + elapsed;
        } else if (current === 'free') {
          displayedFree = freeSeconds + elapsed;
        }
      }
      document.getElementById('workTime').textContent = formatTime(displayedWork);
      document.getElementById('freeTime').textContent = formatTime(displayedFree);
    }
    
    function updateStats() {
      const text = uiText[language];
      let currentWork = workSeconds;
      let currentFree = freeSeconds;
      if (current) {
        const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
        if (current === 'work') {
          currentWork = workSeconds + elapsed;
        } else if (current === 'free') {
          currentFree = freeSeconds + elapsed;
        }
      }
      const totalSeconds = currentWork + currentFree;
      const ratio = totalSeconds > 0 ? (currentWork / totalSeconds * 100).toFixed(1) : 0;
      document.getElementById('workRatio').textContent = `${ratio}%`;
      
      const targetHours = parseInt(document.getElementById('workTarget').value);
      const targetSeconds = targetHours * 3600;
      const progress = (currentWork / targetSeconds * 100).toFixed(0);
      document.getElementById('targetProgress').textContent = 
        `${(currentWork / 3600).toFixed(1)}/${targetHours} ${text.hours} (${progress}%)`;
      
      const efficiency = currentWork > 0 ? ((currentWork / 28800) * 100).toFixed(1) : 0;
      document.getElementById('efficiency').textContent = `${efficiency}%`;
      
      drawCharts();
    }

    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hrs}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    let timeChart, historyChart;

    function initializeCharts() {
      const text = uiText[language];
      const isDark = document.body.classList.contains('dark');
      const textColor = isDark ? '#eee' : '#333';
      
      if (!timeChart) {
        try {
          const timeCtx = document.getElementById('timeChart').getContext('2d');
          
          // Make sure we're using the current values including any elapsed time
          let currentWork = workSeconds;
          let currentFree = freeSeconds;
          if (current) {
            const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
            if (current === 'work') {
              currentWork = workSeconds + elapsed;
            } else if (current === 'free') {
              currentFree = freeSeconds + elapsed;
            }
          }
          
          const timeData = {
            labels: language === 'en' ? ['Work', 'Free Time'] : ['Pr√°ce', 'Voln√Ω ƒåas'],
            datasets: [{
              data: [currentWork, currentFree],
              backgroundColor: ['#66bb6a', '#ef5350'],
              borderColor: isDark ? '#333' : '#fff',
              borderWidth: 2
            }]
          };

          const timeOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 500 },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: textColor }
              },
              title: {
                display: true,
                text: text.distributionTitle,
                color: textColor,
                font: { size: 16 }
              }
            }
          };

          timeChart = new Chart(timeCtx, {
            type: 'doughnut',
            data: timeData,
            options: timeOptions
          });
          
          console.log('Time chart initialized');
        } catch (err) {
          console.error('Error initializing time chart:', err);
        }
      }
      
      initializeHistoryChart(textColor);
    }
    
    function drawCharts() {
      const text = uiText[language];
      const isDark = document.body.classList.contains('dark');
      const textColor = isDark ? '#eee' : '#333';
      
      if (!timeChart || !historyChart) {
        initializeCharts();
        return;
      }
      
      // Update data for time distribution chart (today's work vs. free time)
      timeChart.data.labels = language === 'en' ? ['Work', 'Free Time'] : ['Pr√°ce', 'Voln√Ω ƒåas'];
      
      // Make sure we're using the current values including any elapsed time
      let currentWork = workSeconds;
      let currentFree = freeSeconds;
      if (current) {
        const elapsed = Math.floor((Date.now() - currentStartTime) / 1000);
        if (current === 'work') {
          currentWork = workSeconds + elapsed;
        } else if (current === 'free') {
          currentFree = freeSeconds + elapsed;
        }
      }
      
      // Update chart with current values
      timeChart.data.datasets[0].data[0] = currentWork;
      timeChart.data.datasets[0].data[1] = currentFree;
      timeChart.data.datasets[0].borderColor = isDark ? '#333' : '#fff';
      timeChart.options.plugins.legend.labels.color = textColor;
      timeChart.options.plugins.title.color = textColor;
      timeChart.options.plugins.title.text = text.distributionTitle;
      timeChart.update('none');
      
      updateHistoryChart(textColor);
    }
    
    function initializeHistoryChart(textColor) {
      const text = uiText[language];
      if (!historyChart) {
        try {
          const historyCtx = document.getElementById('historyChart').getContext('2d');
          
          const dates = Object.keys(dailyData).sort().slice(-7);
          const workData = dates.map(date => Math.round(dailyData[date]?.work / 3600 * 10) / 10 || 0);
          const freeData = dates.map(date => Math.round(dailyData[date]?.free / 3600 * 10) / 10 || 0);
          
          const displayDates = dates.map(date => {
            const d = new Date(date);
            return d.toLocaleDateString(language === 'en' ? 'en-US' : 'cs-CZ', { weekday: 'short' });
          });
          
          const historyData = {
            labels: displayDates,
            datasets: [
              {
                label: language === 'en' ? 'Work Hours' : 'Pracovn√≠ Hodiny',
                data: workData,
                backgroundColor: 'rgba(102, 187, 106, 0.7)',
                borderColor: '#66bb6a',
                borderWidth: 2
              },
              {
                label: language === 'en' ? 'Free Hours' : 'Voln√© Hodiny',
                data: freeData,
                backgroundColor: 'rgba(239, 83, 80, 0.7)',
                borderColor: '#ef5350',
                borderWidth: 2
              }
            ]
          };
          
          const historyOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 600 },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: textColor }
              },
              title: {
                display: true,
                text: text.historyTitle,
                color: textColor,
                font: { size: 16 }
              }
            },
            scales: {
              x: {
                grid: { color: textColor === '#333' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' },
                ticks: { color: textColor }
              },
              y: {
                grid: { color: textColor === '#333' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' },
                ticks: { color: textColor },
                title: { display: true, text: text.hours, color: textColor }
              }
            }
          };
          
          historyChart = new Chart(historyCtx, {
            type: 'bar',
            data: historyData,
            options: historyOptions
          });
          
          console.log('History chart initialized');
        } catch (err) {
          console.error('Error initializing history chart:', err);
        }
      }
    }
    
    function updateHistoryChart(textColor) {
      const text = uiText[language];
      
      try {
        // Get the last 7 days of data, sorted by date
        const dates = Object.keys(dailyData).sort().slice(-7);
        
        // Calculate hours for each day
        const workData = dates.map(date => {
          const workSeconds = dailyData[date]?.work || 0;
          return Math.round(workSeconds / 3600 * 10) / 10; // Convert to hours with 1 decimal
        });
        
        const freeData = dates.map(date => {
          const freeSeconds = dailyData[date]?.free || 0;
          return Math.round(freeSeconds / 3600 * 10) / 10; // Convert to hours with 1 decimal
        });
        
        // Format dates for display
        const displayDates = dates.map(date => {
          const d = new Date(date);
          return d.toLocaleDateString(language === 'en' ? 'en-US' : 'cs-CZ', { weekday: 'short' });
        });
        
        // Update chart data
        historyChart.data.labels = displayDates;
        historyChart.data.datasets[0].label = language === 'en' ? 'Work Hours' : 'Pracovn√≠ Hodiny';
        historyChart.data.datasets[1].label = language === 'en' ? 'Free Hours' : 'Voln√© Hodiny';
        historyChart.data.datasets[0].data = workData;
        historyChart.data.datasets[1].data = freeData;
        
        // Update chart appearance
        historyChart.options.plugins.legend.labels.color = textColor;
        historyChart.options.plugins.title.color = textColor;
        historyChart.options.plugins.title.text = text.historyTitle;
        historyChart.options.scales.x.grid.color = textColor === '#333' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
        historyChart.options.scales.x.ticks.color = textColor;
        historyChart.options.scales.y.grid.color = textColor === '#333' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
        historyChart.options.scales.y.ticks.color = textColor;
        historyChart.options.scales.y.title.color = textColor;
        historyChart.options.scales.y.title.text = text.hours;
        
        // Apply changes
        historyChart.update('none');
      } catch (err) {
        console.error('Error updating history chart:', err);
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
      const isDark = document.body.classList.contains('dark');
      const textColor = isDark ? '#eee' : '#333';
      
      if (timeChart && historyChart) {
        timeChart.options.plugins.legend.labels.color = textColor;
        timeChart.options.plugins.title.color = textColor;
        timeChart.data.datasets[0].borderColor = isDark ? '#333' : '#fff';
        timeChart.update();
        
        historyChart.options.plugins.legend.labels.color = textColor;
        historyChart.options.plugins.title.color = textColor;
        historyChart.options.scales.x.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        historyChart.options.scales.x.ticks.color = textColor;
        historyChart.options.scales.y.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        historyChart.options.scales.y.ticks.color = textColor;
        historyChart.options.scales.y.title.color = textColor;
        historyChart.update();
      }
    }
    
    function toggleSettings() {
      const settingsPanel = document.getElementById('settingsPanel');
      settingsPanel.classList.toggle('open');
    }

    function showRandomQuote() {
      const languageQuotes = quotes[language];
      const random = languageQuotes[Math.floor(Math.random() * languageQuotes.length)];
      quoteEl.textContent = `"${random}"`;
    }
    
    // Add event listeners
    document.getElementById('workTarget').addEventListener('change', updateStats);
    document.getElementById('hideMetricsCompletely').addEventListener('change', toggleMetricsEnabled);
  </script>
</body>
</html>